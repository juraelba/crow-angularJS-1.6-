define([], function () {

    function ExploitationController($scope, auth, $rootScope, getQueries, NgTableParams) {
        $scope.userInfo = auth;
        $scope.connectingString = null;
        $rootScope.rootUser = auth;
        $scope.exploitation = {};
        $scope.link = {};
        $scope.editLinks = [];
        $scope.getZenoArtikelenList = [];

        $scope.init = function () {
            $("body").addClass("loading");
            getQueries.getConnectionStrings().then(function (response) {
                $scope.connectingString = response;

                getQueries.getQuery($scope.connectingString, "getArtikelenFromDWH").then(function (response) {
                    $scope.items = response;
                });

                $scope.getZenoArtiklenList();

                getQueries.getQuery($scope.connectingString, "getExploitatie").then(function (response) {
                    var data = response;
                    if (data.length > 0) {
                        $scope.cols = $scope.generateColumns(data[0]);
                        $scope.tableParams = new NgTableParams({
                            page: 1,
                            count: data.length
                        }, {
                            filterDelay: 0,
                            dataset: data,
                            counts: []
                        });
                        $scope.cols[0].show = false;
                    }
                    $("body").removeClass("loading");
                });
            });
        };


        $scope.getZenoArtiklenList = function () {
            getQueries.getQuery($scope.connectingString, "getZenoArtikelen").then(function (response) {
                $scope.getZenoArtikelenList = response;
            });
        };

        $scope.showDetails = function (purchase) {
            $scope.exploitation = purchase;
            angular.forEach($scope.items, function (item) {
                if (item.value == purchase.Artikel) {
                    purchase.Artikel = item.key;
                }
            });
            $scope.initLinks();
            $('.modalAdditional').show();
        };

        $scope.initLinks = function () {
            getQueries.getQuery(
                $scope.connectingString,
                "getZenoArtikelenByExploitatie?exploitatieid=" + $scope.exploitation.id
            ).then(function (response) {
                $scope.articleLinks = response;
                $scope.newLink = false;
            });
        };

        $scope.showAddLink = function () {
            $scope.newLink = true;
            $scope.link.zenoartikel = '';
            $scope.editLinks = []
        };

        $scope.hideAddLink = function () {
            $scope.newLink = false;
        };

        $scope.addLink = function () {
            getQueries.addPost(
                $scope.connectingString,
                'postZenoArtikel',
                {
                    exploitatieid: $scope.exploitation.id,
                    zenoartikel: $scope.link.zenoartikel
                }
            ).then(function (response) {
                $scope.initLinks();
                $scope.getZenoArtiklenList();
                $scope.newLink = false;
            });
        };

        $scope.showEditLink = function (link) {
            $scope.editLinks = [];
            $scope.editLinks[link.Id] = true;
            $scope.link.editZenoartikel = link.ZenoArtikel;
            $scope.newLink = false;
        };

        $scope.hideEditLink = function (link) {
            $scope.editLinks[link.Id] = false;
        };

        $scope.saveEditLink = function (link) {
            getQueries.addPost(
                $scope.connectingString,
                'putZenoArtikel',
                {
                    zenoartikelid: link.Id,
                    zenoartikel: $scope.link.editZenoartikel
                }
            ).then(function (response) {
                $scope.editLinks[link.Id] = false;
                $scope.initLinks();
                $scope.getZenoArtiklenList();
            });
        };

        $scope.removeLink = function (link) {
            getQueries.addPost(
                $scope.connectingString,
                'deleteZenoArtikel',
                {
                    zenoartikelid: link.Id
                }
            ).then(function (response) {
                $scope.initLinks();
                $scope.getZenoArtiklenList();
            });
        };

        $scope.saveForm = function () {
            var sendFunction = $scope.exploitation.id ? 'putExploitatie' : 'postExploitatie';
            var data = {
                Naam: $scope.exploitation.Omschrijving,
                Artikel: $scope.exploitation.Artikel
            };
            if ($scope.exploitation.id) {
                data['Id'] = $scope.exploitation.id;
            }
            getQueries.addPost($scope.connectingString, sendFunction, data).then(function (response) {
                if (response.data.Success) {
                    $scope.exploitation = {};
                    $('.modalAdditional').hide();
                    $scope.init();
                } else {
                    $scope.exploitation.error = response.data.ErrorMessage;
                }
            });
        };

        $scope.init();
    }

    ExploitationController.$inject = ["$scope", "auth", "$rootScope", "getQueries", "NgTableParams"];

    return ExploitationController;
});